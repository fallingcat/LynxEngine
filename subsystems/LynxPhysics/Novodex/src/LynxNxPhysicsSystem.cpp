#include <LynxEngine_PCH.h>

#ifdef __PHYSX__

#include <LynxNxPhysicsSystem.h>
#include <LynxNxPhysicsWorld.h>

namespace LynxPhysics 
{
	namespace Novodex 
	{
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//UserStream::UserStream(const LYNXCHAR* filename, bool load)
		//{
		//	lynxInitFile(&File);
		//	if (load)
		//		LYNX_OPEN_FILE(&File, filename, LYNX_FOT_BINARY|LYNX_FOT_READ, LYNX_FILE_STR);
		//	else
		//		LYNX_OPEN_FILE(&File, filename, LYNX_FOT_BINARY|LYNX_FOT_WRITE, LYNX_FILE_STR);
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//UserStream::~UserStream()
		//{
		//	LYNX_CLOSE_FILE(&File);
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//NxU8 UserStream::readByte() const
		//{
		//	NxU8 b;
		//	size_t r = LYNX_BYTE_ORDER_READ_FILE(&b, sizeof(NxU8), 1, &File);
		//	NX_ASSERT(r);
		//	return b;
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//NxU16 UserStream::readWord() const
		//{
		//	NxU16 w;
		//	size_t r = LYNX_BYTE_ORDER_READ_FILE(&w, sizeof(NxU16), 1, &File);
		//	NX_ASSERT(r);
		//	return w;
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//NxU32 UserStream::readDword() const
		//{
		//	NxU32 d;
		//	size_t r = LYNX_BYTE_ORDER_READ_FILE(&d, sizeof(NxU32), 1, &File);
		//	NX_ASSERT(r);
		//	return d;
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//float UserStream::readFloat() const
		//{
		//	NxReal f;
		//	size_t r = LYNX_BYTE_ORDER_READ_FILE(&f, sizeof(NxReal), 1, &File);
		//	NX_ASSERT(r);
		//	return f;
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//double UserStream::readDouble() const
		//{
		//	NxF64 f;
		//	size_t r = LYNX_BYTE_ORDER_READ_FILE(&f, sizeof(NxF64), 1, &File);
		//	NX_ASSERT(r);
		//	return f;
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//void UserStream::readBuffer(void* buffer, NxU32 size)	const
		//{
		//	size_t w = LYNX_READ_FILE(buffer, size, 1, &File);
		//	NX_ASSERT(w);
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//NxStream& UserStream::storeByte(NxU8 b)
		//{
		//	size_t w = LYNX_WRITE_FILE(&b, sizeof(NxU8), 1, &File);
		//	NX_ASSERT(w);
		//	return *this;
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//NxStream& UserStream::storeWord(NxU16 w)
		//{
		//	size_t ww = LYNX_WRITE_FILE(&w, sizeof(NxU16), 1, &File);
		//	NX_ASSERT(ww);
		//	return *this;
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//NxStream& UserStream::storeDword(NxU32 d)
		//{
		//	size_t w = LYNX_WRITE_FILE(&d, sizeof(NxU32), 1, &File);
		//	NX_ASSERT(w);
		//	return *this;
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//NxStream& UserStream::storeFloat(NxReal f)
		//{
		//	size_t w = LYNX_WRITE_FILE(&f, sizeof(NxReal), 1, &File);
		//	NX_ASSERT(w);
		//	return *this;
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//NxStream& UserStream::storeDouble(NxF64 f)
		//{
		//	size_t w = LYNX_WRITE_FILE(&f, sizeof(NxF64), 1, &File);
		//	NX_ASSERT(w);
		//	return *this;
		//}
		////-------------------------------------------------------------------------------------------------------
		////
		////  說明:   
		////-------------------------------------------------------------------------------------------------------
		//NxStream& UserStream::storeBuffer(const void* buffer, NxU32 size)
		//{
		//	size_t w = LYNX_WRITE_FILE(buffer, size, 1, &File);
		//	NX_ASSERT(w);
		//	return *this;
		//}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		MemoryWriteBuffer::MemoryWriteBuffer() : currentSize(0), maxSize(0), data(NULL)
		{
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		MemoryWriteBuffer::~MemoryWriteBuffer()
		{
			lynxMemFree(data);
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		NxStream& MemoryWriteBuffer::storeByte(NxU8 b)
		{
			storeBuffer(&b, sizeof(NxU8));
			return *this;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		NxStream& MemoryWriteBuffer::storeWord(NxU16 w)
		{
			storeBuffer(&w, sizeof(NxU16));
			return *this;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		NxStream& MemoryWriteBuffer::storeDword(NxU32 d)
		{
			storeBuffer(&d, sizeof(NxU32));
			return *this;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		NxStream& MemoryWriteBuffer::storeFloat(NxReal f)
		{
			storeBuffer(&f, sizeof(NxReal));
			return *this;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		NxStream& MemoryWriteBuffer::storeDouble(NxF64 f)
		{
			storeBuffer(&f, sizeof(NxF64));
			return *this;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		NxStream& MemoryWriteBuffer::storeBuffer(const void* buffer, NxU32 size)
		{
			NxU32 expectedSize = currentSize + size;
			if(expectedSize > maxSize)
			{
				maxSize = expectedSize + 4096;

				NxU8* newData = (NxU8*)lynxMemAlloc(maxSize);
				if(data)
				{
					lynxMemCpy(newData, data, currentSize);
					lynxMemFree(data);
				}
				data = newData;
			}
			lynxMemCpy(data+currentSize, buffer, size);
			currentSize += size;
			return *this;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		MemoryReadBuffer::MemoryReadBuffer(const NxU8* data) : buffer(data)
		{
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		MemoryReadBuffer::~MemoryReadBuffer()
		{
			// We don't own the data => no delete
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		NxU8 MemoryReadBuffer::readByte() const
		{
			NxU8 b;
			lynxMemCpy(&b, buffer, sizeof(NxU8));
			buffer += sizeof(NxU8);
			return b;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		NxU16 MemoryReadBuffer::readWord() const
		{
			NxU16 w;
			lynxMemCpy(&w, buffer, sizeof(NxU16));
			buffer += sizeof(NxU16);
			return w;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		NxU32 MemoryReadBuffer::readDword() const
		{
			NxU32 d;
			lynxMemCpy(&d, buffer, sizeof(NxU32));
			buffer += sizeof(NxU32);
			return d;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		float MemoryReadBuffer::readFloat() const
		{
			float f;
			lynxMemCpy(&f, buffer, sizeof(float));
			buffer += sizeof(float);
			return f;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		double MemoryReadBuffer::readDouble() const
		{
			double f;
			lynxMemCpy(&f, buffer, sizeof(double));
			buffer += sizeof(double);
			return f;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		void MemoryReadBuffer::readBuffer(void* dest, NxU32 size) const
		{
			lynxMemCpy(dest, buffer, size);
			buffer += size;
		}
		

		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		CPhysicsSystem::CPhysicsSystem(LynxEngine::CEngine* const lpengine)
		: LynxEngine::PhysicsSystem::CPhysicsSystem(lpengine)
		{			
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		CPhysicsSystem::~CPhysicsSystem(void)
		{			
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		LYNXBOOL CPhysicsSystem::vCreate(void)
		{			
			return LYNX_TRUE;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		LYNXBOOL CPhysicsSystem::vInit(void)
		{
			m_NxPhySDK = NxCreatePhysicsSDK(NX_PHYSICS_SDK_VERSION, &m_MemAllocator);
			if (!m_NxPhySDK)  
				return LYNX_FALSE;

			// Set the physics parameters
			m_NxPhySDK->setParameter(NX_SKIN_WIDTH, m_CollisionThreshold);

			// Set the debug visualization parameters
			//m_NxPhySDK->setParameter(NX_VISUALIZATION_SCALE, 1);
			//m_NxPhySDK->setParameter(NX_VISUALIZE_COLLISION_SHAPES, 1);
			//m_NxPhySDK->setParameter(NX_VISUALIZE_ACTOR_AXES, 1);	

			CSystem::vInit();

			return LYNX_TRUE;
		}
		//-------------------------------------------------------------------------------------------------------
		//
		//  說明:   
		//-------------------------------------------------------------------------------------------------------
		LynxEngine::PhysicsSystem::CPhysicsWorld* const CPhysicsSystem::vCreateWorld(void)
		{
			//GUARD(PhysicsSystem::vCreateWorld)		

			LynxEngine::PhysicsSystem::CPhysicsWorld* lpWorld = LYNXNEW CPhysicsWorld(this);

			if (lpWorld)
			{
				lpWorld->vCreate();
				AddWorld(lpWorld);
			}
			return lpWorld;

			//UNGUARD
			//catch (LynxEngine::CException& e) { lynxDebugOutputPrintf(e.GetMessage().c_str()); return LYNX_FALSE; }
			//DEFAULTCATCH
		}
	}
}

#endif