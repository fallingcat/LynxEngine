//###########################################################################
//    __                    ____            __
//   / /  __ __ ___ _  __  / __/___  ____  /_/___  ____
//  / /__/ // /  _ \ \/ / / __/  _ \/ __ \/ /  _ \/  _/
//  \___/__, /__//_/_/\_\ \__/__//_/\__, /_/__//_/\__/
//      /___/                       /___/ 
// 
//  Copyright (C) 2003~2006 fallingCAT studios. All Rights Reserved.
//	URL : http://www.LynxEngine.net
//
//--------------------------------------------------------------------------
//
//  Best viewed with Tabs = 4.
//  Created by Owen Wu : 2004/07/27
//  Last Update : 
//
//###########################################################################

#ifndef __LYNXCRYPTIC_H__
#define __LYNXCRYPTIC_H__

#include <LynxType.h>
#include <LynxMem.h>

void lynxSetMemoryHackingDetectionFlag(LYNXBOOL b);

namespace LynxEngine 
{	
	template <class T> class CCryptic
	{
	protected:
		T					m_Value;
		LYNXBYTE			m_Key[4];				
		LYNXBYTE			m_RefKey[4];
		T					m_RefValue;
		#ifdef _DEBUG
			T				m_RealValue;
		#endif
	protected:
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		LYNXFORCEINLINE void Shuffle(T& result, const T& value)
		{
			result = value;
			int Len = sizeof(T) / sizeof(LYNXUINT);
			LYNXUINT* pValue = (LYNXUINT*)(&result);

			for (int i = 0; i < Len; i++)
			{
				LYNXUINT x = *pValue;
				LYNXUINT t = (x ^ (x >> 8)) & 0x0000FF00; x = x ^ t ^ (t << 8);
				t = (x ^ (x >> 4)) & 0x00F000F0; x = x ^ t ^ (t << 4);
				t = (x ^ (x >> 2)) & 0x0C0C0C0C; x = x ^ t ^ (t << 2);
				t = (x ^ (x >> 1)) & 0x22222222; x = x ^ t ^ (t << 1);
				x ^= 0x55555555;
				*pValue = x;
				pValue++;
			}			
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		LYNXFORCEINLINE const T Unshuffle(const T& value) const
		{
			T Value = value;
			int Len = sizeof(T) / sizeof(LYNXUINT);
			LYNXUINT* pValue = (LYNXUINT*)(&Value);

			for (int i = 0; i < Len; i++)
			{
				LYNXUINT x = *pValue;
				x ^= 0x55555555;
				LYNXUINT t = (x ^ (x >> 1)) & 0x22222222; x = x ^ t ^ (t << 1);
				t = (x ^ (x >> 2)) & 0x0C0C0C0C; x = x ^ t ^ (t << 2);
				t = (x ^ (x >> 4)) & 0x00F000F0; x = x ^ t ^ (t << 4);
				t = (x ^ (x >> 8)) & 0x0000FF00; x = x ^ t ^ (t << 8);
				*pValue = x;
				pValue++;
			}
			return Value;
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		LYNXFORCEINLINE void XOREncrypt(T& result, const T& value, const LYNXBYTE key[])
		{
			result = value;

			int Len = sizeof(T);
			LYNXBYTE* pValue = (LYNXBYTE*)(&result);
			for (int i = 0; i < Len; i++)
			{
				*pValue = (*pValue) ^ key[i % 4];
				pValue++;
			}
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		LYNXFORCEINLINE const T XORDecrypt(const T& value, const LYNXBYTE key[]) const
		{
			T Value = value;

			int Len = sizeof(T);
			LYNXBYTE* pValue = (LYNXBYTE*)(&Value);
			for (int i = 0; i < Len; i++)
			{
				*pValue = (*pValue) ^ key[i % 4];
				pValue++;
			}
			return (Value);
		}
		/*
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		LYNXFORCEINLINE T& Encrypt(const T& value)
		{
			//return Shuffle(value);

			XOREncrypt(m_Value, value, m_Key);
			
			m_RefValue = m_Value;

			return (m_Value);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		LYNXFORCEINLINE const T Decrypt() const
		{
			//return Unshuffle();

			// if memory has been modified!!
			if (m_RefValue != m_Value)
				return (T)0;

			T Value = XORDecrypt(m_Value, m_Key);

			return (Value);
		}		
		*/
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		LYNXFORCEINLINE T& Encrypt(const T& value)
		{
			#ifdef _DEBUG
				m_RealValue = value;
			#endif

			//Shuffle(m_Value, value);
			//Shuffle(m_RefValue, value);

			XOREncrypt(m_Value, value, m_Key);
			XOREncrypt(m_RefValue, value, m_RefKey);

			return (m_Value);
		}		
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		LYNXFORCEINLINE const T Decrypt() const
		{
			T Value = XORDecrypt(m_Value, m_Key);
			T RefValue = XORDecrypt(m_RefValue, m_RefKey);

			//T Value = Unshuffle(m_Value);
			//T RefValue = Unshuffle(m_RefValue);



			#ifdef _DEBUG
				//LYNX_ASSERT(Value == m_RealValue && RefValue == m_RealValue)
				if (Value != m_RealValue || RefValue != m_RealValue)
				{
					int xxx = 0;
				}
			#endif
			// if memory has been modified!!
			if (Value != RefValue)
			{
				lynxSetMemoryHackingDetectionFlag(LYNX_TRUE);
				return (const T)0;
			}

			return (Value);
		}
	public:		
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		CCryptic()		
		{			
			/*
			m_Key[0] = lynxRand() % 100;
			m_Key[1] = lynxRand() % 100;
			m_Key[2] = lynxRand() % 100;
			m_Key[3] = lynxRand() % 100;

			m_RefKey[0] = lynxRand() % 100;
			m_RefKey[1] = lynxRand() % 100;
			m_RefKey[2] = lynxRand() % 100;
			m_RefKey[3] = lynxRand() % 100;
			*/

			m_Key[0] = 34;
			m_Key[1] = 165;
			m_Key[2] = 241;
			m_Key[3] = 67;

			m_RefKey[0] = 74;
			m_RefKey[1] = 124;
			m_RefKey[2] = 96;
			m_RefKey[3] = 87;							
			
			Encrypt((T)0);			
			

			/*
			m_Key[0] = gKey[0];
			m_Key[1] = gKey[1];
			m_Key[2] = gKey[2];
			m_Key[3] = gKey[3];
			m_RefKey[0] = gRefKey[0];
			m_RefKey[1] = gRefKey[1];
			m_RefKey[2] = gRefKey[2];
			m_RefKey[3] = gRefKey[3];
			Encrypt((T)0);
			*/
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		~CCryptic()
		{ 			
		}		
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		const T GetValue() const
		{
			return m_Value;
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		operator T2() const { return (T2)(Decrypt()); };		
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		operator T() const { return (Decrypt()); };
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------				
		T operator *() { return (T)(Decrypt()); };
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------			
		template <class T2>
		CCryptic<T>& operator =(const T2& rhs)
		{			
			T Value = (T)rhs;
			Encrypt(Value);

			return (*this);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------					
		CCryptic<T>& operator =(const CCryptic<T>& rhs)
		{
			T Value = rhs.Decrypt();
			Encrypt(Value);
			
			return (*this);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------					
		template <class T2>
		CCryptic<T>& operator =(const CCryptic<T2>& rhs)
		{
			T Value = (T)(rhs.Decrypt());
			Encrypt(Value);

			return (*this);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------				
		void operator ++()
		{
			T Value = Decrypt();
			++Value;
			Encrypt(Value);
		}		
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------				
		CCryptic<T>& operator ++(const int n)
		{
			T Value = Decrypt();
			Value++;
			Encrypt(Value);

			return (*this);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------			
		void operator --()
		{
			T Value = Decrypt();
			--Value;
			Encrypt(Value);
		}		
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------				
		CCryptic<T>& operator --(const int n)
		{
			T Value = Decrypt();
			Value--;
			Encrypt(Value);

			return (*this);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		void operator +=(const T2& rhs)
		{
			T Value = Decrypt();
			Value += rhs;
			Encrypt(Value);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		void operator -=(const T2& rhs)
		{
			T Value = Decrypt();
			Value -= rhs;
			Encrypt(Value);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		T operator -(const T2& rhs) const
		{
			T Value = Decrypt();
			Value -= rhs;
			return Value;
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		T operator +(const T2& rhs) const
		{
			T Value = Decrypt();
			Value += rhs;
			return Value;
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		T operator *(const T2& rhs) const
		{
			T Value = Decrypt();
			Value *= rhs;
			return Value;
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		T operator /(const T2& rhs) const
		{
			T Value = Decrypt();
			Value /= rhs;
			return Value;
		}		
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		bool operator ==(const T2& rhs) const
		{
			return (Decrypt() == rhs);
		}		
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		bool operator !=(const T2& rhs) const
		{
			return (Decrypt() != rhs);
		}		
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		bool operator >=(const T2& rhs) const
		{
			return (Decrypt() >= rhs);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------				
		template <class T2>
		bool operator <=(const T2& rhs) const
		{
			return (Decrypt() <= rhs);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------			
		template <class T2>
		bool operator >(const T2& rhs) const
		{
			return (Decrypt() > rhs);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------			
		template <class T2>
		bool operator <(const T2& rhs) const
		{
			return (Decrypt() < rhs);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		void operator +=(const CCryptic<T2>& rhs)
		{
			T Value = Decrypt();
			Value += rhs.Decrypt();
			Encrypt(Value);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		void operator -=(const CCryptic<T2>& rhs)
		{
			T Value = Decrypt();
			Value -= rhs.Decrypt();
			Encrypt(Value);
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		T operator -(const CCryptic<T2>& rhs) const
		{
			T Value = Decrypt();
			Value -= rhs.Decrypt();
			return Value;
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		T operator +(const CCryptic<T2>& rhs) const
		{
			T Value = Decrypt();
			Value += rhs.Decrypt();
			return Value;
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		T operator *(const CCryptic<T2>& rhs) const
		{
			T Value = Decrypt();
			Value *= rhs.Decrypt();
			return Value;
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		T operator /(const CCryptic<T2>& rhs) const
		{
			T Value = Decrypt();
			Value /= rhs.Decrypt();
			return Value;
		}	
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------				
		template <class T2>
		bool operator ==(const CCryptic<T2>& rhs) const
		{
			return (Decrypt() == rhs.Decrypt());
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------				
		template <class T2>
		bool operator !=(const CCryptic<T2>& rhs) const
		{
			return (Decrypt() != rhs.Decrypt());
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------				
		template <class T2>
		bool operator <=(const CCryptic<T2>& rhs) const
		{
			return (Decrypt() <= rhs.Decrypt());
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------				
		template <class T2>
		bool operator >=(const CCryptic<T2>& rhs) const
		{
			return (Decrypt() >= rhs.Decrypt());
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------		
		template <class T2>
		bool operator <(const CCryptic<T2>& rhs) const
		{
			return (Decrypt() < rhs.Decrypt());
		}
		//-------------------------------------------------------------------------------------------------------
		//		
		//-------------------------------------------------------------------------------------------------------	
		template <class T2>
		bool operator >(const CCryptic<T2>& rhs) const
		{
			return (Decrypt() > rhs.Decrypt());
		}
    };	
	//-------------------------------------------------------------------------------------------------------
	//		
	//-------------------------------------------------------------------------------------------------------		
	template <class T, class T2>
	T operator +(const T2& lhs, const CCryptic<T>& rhs)
	{
		T Value = (T)rhs;
		Value = lhs + Value;
		return Value;
	}
	//-------------------------------------------------------------------------------------------------------
	//		
	//-------------------------------------------------------------------------------------------------------		
	template <class T, class T2>
	T operator -(const T2& lhs, const CCryptic<T>& rhs)
	{
		T Value = (T)rhs;
		Value = lhs - Value;
		return Value;
	}
	//-------------------------------------------------------------------------------------------------------
	//		
	//-------------------------------------------------------------------------------------------------------		
	template <class T, class T2>
	T operator *(const T2& lhs, const CCryptic<T>& rhs)
	{
		T Value = (T)rhs;
		Value = lhs * Value;
		return Value;
	}
	//-------------------------------------------------------------------------------------------------------
	//		
	//-------------------------------------------------------------------------------------------------------		
	template <class T, class T2>
	T operator /(const T2& lhs, const CCryptic<T>& rhs)
	{
		T Value = (T)rhs;
		Value = lhs / Value;
		return Value;
	}
	//-------------------------------------------------------------------------------------------------------
	//		
	//-------------------------------------------------------------------------------------------------------		
	template <class T, class T2>
	bool operator >(const T2& lhs, const CCryptic<T>& rhs)
	{
		T Value = (T)rhs;		
		return (lhs > Value);
	}
	//-------------------------------------------------------------------------------------------------------
	//		
	//-------------------------------------------------------------------------------------------------------		
	template <class T, class T2>
	bool operator >=(const T2& lhs, const CCryptic<T>& rhs)
	{
		T Value = (T)rhs;		
		return (lhs >= Value);
	}
	//-------------------------------------------------------------------------------------------------------
	//		
	//-------------------------------------------------------------------------------------------------------		
	template <class T, class T2>
	bool operator ==(const T2& lhs, const CCryptic<T>& rhs)
	{
		T Value = (T)rhs;
		return (lhs == Value);
	}
	//-------------------------------------------------------------------------------------------------------
	//		
	//-------------------------------------------------------------------------------------------------------		
	template <class T, class T2>
	bool operator !=(const T2& lhs, const CCryptic<T>& rhs)
	{
		T Value = (T)rhs;
		return (lhs != Value);
	}
	//-------------------------------------------------------------------------------------------------------
	//		
	//-------------------------------------------------------------------------------------------------------		
	template <class T, class T2>
	bool operator <(const T2& lhs, const CCryptic<T>& rhs)
	{
		T Value = (T)rhs;
		return (lhs < Value);
	}
	//-------------------------------------------------------------------------------------------------------
	//		
	//-------------------------------------------------------------------------------------------------------		
	template <class T, class T2>
	bool operator <=(const T2& lhs, const CCryptic<T>& rhs)
	{
		T Value = (T)rhs;
		return (lhs <= Value);
	}	
}

#endif